package com.example.android.effectivenavigation;

import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.Socket;

import com.rabbitmq.client.Channel;
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

import android.app.Activity;
import android.content.SharedPreferences;
import android.os.AsyncTask;
import android.preference.PreferenceManager;
import android.widget.TextView;
import android.widget.Toast;

public class TcpHelper extends AsyncTask<Object, Object, String> {

	public Activity Context;
	private final static String QUEUE_NAME = "helloWorld";
	private TransferData runCommand(Object... commands) {
		String command = commands[0].toString();
		
		
		try {

			ConnectionFactory factory = new ConnectionFactory();
			factory.setHost("192.168.1.3");
			Connection connection= factory.newConnection();

			

			Channel channel = connection.createChannel();

			channel.queueDeclare(QUEUE_NAME, false, false, false, null);
			String message = "123456789";
			channel.basicPublish("", QUEUE_NAME, null, message.getBytes());
			System.out.println(" [x] Sent '" + message + "'");

			channel.close();
			connection.close();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		

		try {
			String sentence;
			String modifiedSentence = "";

			SharedPreferences settings = PreferenceManager
					.getDefaultSharedPreferences(Context);

			String arduinoIp = settings
					.getString("prefHomeIp", "192.168.1.3");
			String arduinoPort = settings.getString("prefHomePort", "13000");

			Socket clientSocket = new Socket(arduinoIp,
					Integer.parseInt(arduinoPort));
			DataOutputStream outToServer = new DataOutputStream(
					clientSocket.getOutputStream());
			BufferedReader inFromServer = new BufferedReader(
					new InputStreamReader(clientSocket.getInputStream()));
			sentence = command.toString();
			outToServer.writeBytes(sentence);
			modifiedSentence = inFromServer.readLine();

			clientSocket.close();
			return deserializeReceived(modifiedSentence);
		} catch (Exception ex) {
			TransferData transferData = new TransferData();
			transferData.Message = ex.getMessage();
			return transferData;
		}

	}

	protected TransferData deserializeReceived(String data) {
		return new TransferData(data);
	}

	protected void onPostExecute(String result) {
		Toast.makeText((Activity) Context, result, Toast.LENGTH_SHORT).show();
	}

	public void Run(String command, Activity context) {
		execute(command, context);
	}

	@Override
	protected String doInBackground(Object... params) {
		Context = (Activity) params[1];
		final TransferData transferData = runCommand(params);

		switch (transferData.CommandType) {
		case 1:
			break;
		case 4:
			break;
		case 3:
			break;
		case 2:
			break;
		case 5:
			Context.runOnUiThread(new Runnable() {

				@Override
				public void run() {
					TextView nextShutdownTextView = (TextView) Context
							.findViewById(R.id.nextShutdownTextView);
					nextShutdownTextView.setText(transferData.Message);
				}
			});

			break;
		default:
			break;
		}

		return transferData.Message;
	}

}